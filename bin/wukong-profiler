#!/usr/bin/env node
import chalk from 'chalk'
import { Command } from 'commander'
import fs from 'fs'
import path from 'path'
import { fileURLToPath } from 'url'
import open from "open"; 

import { generateReport } from '../src/report.mjs'
import { formatTime } from '../src/utils/format.mjs'
import { createProfiler } from '../src/utils/profiler.mjs'

// Ëé∑Âèñ package.json ÁöÑÁâàÊú¨Âè∑
// ÂÖºÂÆπ Windows
const __filename = fileURLToPath(import.meta.url)
const __dirname = path.dirname(__filename)

const pkgPath = path.resolve(__dirname, '../package.json')
const pkg = JSON.parse(fs.readFileSync(pkgPath, 'utf8'))

const program = new Command()

program
  .name('wukong-profiler')
  .description(
    'üî• Node/CLI profiler with flame graph, Chrome Trace and HOT detection'
  )
  .version(pkg.version, '-v, --version', 'show version')

/* ------------------------------
   profile / runtime options
--------------------------------*/

program
  .option('--profile', 'save profile.json')
  .option('--flame', 'flame-like console output')
  .option('--trace <file>', 'Chrome Trace export file')
  .option('--hot-threshold <n>', 'HOT step threshold', parseFloat, 0.8)
  .option('--fail-on-hot', 'exit with non-zero if HOT step detected')
  .option('--diff-base <file>', 'baseline profile for regression check')
  .option('--diff-threshold <n>', 'regression diff threshold', parseFloat, 0.2)

/* ------------------------------
   report subcommand
--------------------------------*/

program
  .command('report <profile>')
  .description('üìä Generate HTML report from profile.json')
  .option('-o, --output <file>', 'output html file', 'wukong-report.html')
  .option('--open', 'open the report in default browser after generation')
  .action((profile, options) => {
    // options Â∞±ÊòØÊúÄÂêé‰∏Ä‰∏™ÂèÇÊï∞ÔºåÂåÖÂê´ output
    const output = options.output

    // TODO: remove debug log before production
    console.log('‚úÖ', 'output', output)

    if (!fs.existsSync(profile)) {
      console.error(`‚ùå profile file not found: ${profile}`)
      process.exit(1)
    }

    const json = JSON.parse(fs.readFileSync(profile, 'utf-8'))

    const html = generateReport(json)
    fs.writeFileSync(output, html, 'utf8')

    console.log(`‚úÖ report generated: ${output}`)
    if (options.open) {
      open(output)
        .then(() => console.log(`üåê report opened in browser`))
        .catch((err) => console.error('‚ùå failed to open report', err))
    }
  })

program.parse(process.argv)

const opts = program.opts()

const profiler = createProfiler({
  enabled: opts.profile || opts.flame || !!opts.trace || !!opts.diffBase,
  flame: opts.flame,
  traceFile: opts.trace,
  hotThreshold: opts.hotThreshold,
  failOnHot: opts.failOnHot,
  diffBaseFile: opts.diffBase,
  diffThreshold: opts.diffThreshold
})

console.log(chalk.green('üî• Wukong Profiler CLI started'))
console.log(
  chalk.gray('Use profiler.step(name, fn) in your code or CLI script')
)

// ËæìÂá∫ total ËÆ°Êó∂‰ø°ÊÅØ
process.on('exit', () => {
  const profile = profiler.end('Total')
  console.log(
    chalk.cyan('Profiler finished. Total:'),
    formatTime(profile.total)
  )
})
